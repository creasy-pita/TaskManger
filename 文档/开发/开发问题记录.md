##术语
	调度web服务：实施人员通过浏览器操作，管理节点，任务开启|监控|关闭等
	节点程序：管理用于运行任务程序的服务器， 节点下会预先部署一个控制台程序，用户调度配置运行在本服务器下的任务
	任务程序：
			windows控制台程序：主要用于跑定时 或者长时任务
			tomcat web服务
			jar包微服务
			需要界面输入和多次交互型的程序 不适用， 比如基础研发中心的表单程序
##标签  
+ 功能问题
+ 代码问题
+ 功能设计
+ 功能优化

##部署相关

+ TBD 目前 windows 服务的查找进程 启动需要使用powershell.exe 运行 Get-WmiObject win32_service -filter "name = 'GtCxService_LSSJ' and State='Running'"| Select-Object -ExpandProperty ProcessId；或者 cmd 运行GetWinServiceProcessId-Via-CMD-ByServiceName.bat
+ 
+ 

##2019年7月10日
功能问题

+ 问题：<font color='red'>`多系统兼容问题`</font> 纯bat 或者现在的process类 去操作任务进程的启动 关闭 方式是否适用所有生产环境
	+  比如 相同的windowOS version ,有些是使用新建的windows 管理员用户 去执行 注册安装window服务 会存在不成功的问题
	+  不同 windowOS version  同样的bat 在处理输入，输出 字符串 格式会有不同导致不能正确运行
+ 解决方式： 尽可能实验验证各种可能的系统差异场景


##2019年7月9日

功能设计

+ 任务开启 查找进程问题
	+ 如果使用 C# Process ProcessStartInfo 开启的进程， 参数会保存再commandline 中，可以通过cmd,poweshell 中的 Get-WmiObject Win32_Process  -Filter "commandline like '%dotnet arguments%'" 找到
	+ 如果使用 cmd 中的命令来打开， 参数不会保存在commandline中， 后续也就不能定位这个进程
	+ 解决方式
		+ 1 使用 powershell  start-process 结合 New-object System.Diagnostics.ProcessStartInfo 
			+ 参考： https://www.sapien.com/forums/viewtopic.php?t=9641
			+ 参考：https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/start-process?view=powershell-6
					Example 6
			+ 以上方法存在问题， ProcessStartInfo 设置了 arguments 也不能被Get-WmiObject 命令取到
		+ 2 创建net application ， 并发布为FindProcess.exe, exe 功能是通过 进程开启的参数来匹配进程。 <font color="red">**后续可以注册为 window 外部命令行 ，这样可以bat调用就可以查找 进程**</font>
			+ 参考 文档 exe 中的 consoleApp
			+ 
		+   


##2019年7月5日

功能问题

+ 任务 保存和更新  成功后 有些字段的更新没有正确保存

功能设计
服务管理平台 的 后续需要完善功能 分析

+ 1 挂载  
+ 2 操作命令 细化 扩展为  安装 启动  关闭 卸载  （健康检查的步骤在 考量）
	+ 安装	
		+ 	window服务的 则下载程序包并安装注册为服务
		+ 一般程序  下载程序包
	+ 启动
		+ 检查第一步的安装， 如果为下载包则下载， 同时安装注册为服务
		+ 启动
	+ 关闭
		+ 检查是否再启动中， 如果时 查找进程并关闭
	+ 卸载
		+ 卸载包括 卸载服务并 删除程序包
+ 3 操作命令 使用  定制好的bat  ,每种工具服务的 bat 脚本会有不同， 同一工具如果相同
+ 4 工具程序 使用一个库来管理， 任务界面可以选择 工具库中的库文件 
+ 5 工具启动，关闭 等使用bat 来完成， 需要能够记录这些启动的日志， 但操作命令出错时 可以收集这部分日志方便后续排查
	+  bat 中当错误发生时 可以记录到系统日志（就像 installutil.exe 会记录过程日志到  install.Log 中）
	+  即 类似于 程序记录日志 即可以选择控制台输出 也可以记录到其他资源 文件 或者  数据库 
+ 6 工具运行中的日志需要挂载到外部， 这样卸载时不会丢失
	+ 可以按 任务名称 为表示 保存到 节点服务器的固定目录，这个目录在 运行启动命令的bat 时以参数形式传入
	+ 参数名称  可以时  -v=/root/Software/Log/zjzjtool1:/var/lib/zjzjtool1/Log

+ 7 查找进程 使用powershell  exe，是否可以修改为 cmd.exe ,只是脚本会复杂一点
+ 8 运维上的 简洁（复杂度的转移）
	需要每个镜像已经完成一些初始的设置，然后再镜像 start 为容器时 定制一套  Options  来设置不同的特性
	服务管理平台也可以参照这种做法
+ 9 *** 服务管理平台 参考jekins  对启动 关闭各个步骤的操作 完全使用 批处理脚本   
	+ **提供定制界面  任务需要的工具服务从工具服务仓库中选择 工具服务仓库 中的各个步骤的脚本由开发人员实现定制** 
	+ **对于一个步骤（即一个操作命令） 比如 卸载 可以包括 解除windows服务的注册 的脚本 和 卸载程序目录的脚本**（**需要考虑脚本能否合并成一个**） 
	+ 任务服务由实施人员 维护  工具服务仓库的脚本由开发人员维护
+ 10 *** 服务管理平台 服务的启动， 查找 和 关闭 卸载 都使用定制的bat
	+ 目前 是 开启时 使用 process类 带入taskstartfilename + taskaruments 参数来启动
	+ 修改目标 以下能尽量使用 bat ,process 直接执行bat 来完成操作 
		+ 开启
		+ 查找进程是否正常
		+ 健康检查
		+ 关闭
		+ 卸载
	+ 说明： docker 有  dockers start|stop|remove|ps 等操作， 也应该时去执行一个 shell script （可传参的）


##2019年7月4日
1 
同一个window任务 单个节点上多个副本时 如何区分

+ window服务形式程序
	+  服务名不同 
		+  解决方式 1 启动批处理bat时可以传参 （推荐）
		+  解决方式 2 设置到 程序初始化运行 需要读取的配置文件设置项中
		+   
+ 控制台形式程序
	+  开启时需要传入不同的参数
		+  解决方式 1 定制bat,启动时调用bat 时可以传参数，参数作为启动,bat 放入程序目录与程序一起分发  
		+  启动样式   
			+  cmd /c ""F:\taskdllroot\zjzstool1\commondllstart.bat"" -entrypoint=zjzstool1.dll -dllstartarg1=type1 -dllstartarg2=type2
			+  commondllstart.bat 内部去使用 -entrypoint=zjzstool1.dll 作为启动的程序入口dll,-dllstartarg1=type1 作为启动程序的第一个参数
		+ 卸载样式
			+ 

相同window服务 部署多次时

##2019年7月3日
功能优化

+ 服务管理平台 服务的启动， 查找 和 关闭 卸载 都使用定制的bat
	+ 目前 是 开启时 使用 process类 带入taskstartfilename + taskaruments 参数来启动
	+ 修改目标 以下能尽量使用 bat ,process 直接执行bat 来完成操作 
		+ 开启   
		+ 查找进程是否正常
		+ 健康检查
		+ 关闭
		+ 卸载
		+ 说明： 可以参考 docker的方式， 有  dockers start|stop|remove|ps 等操作 注： 命令背后也应该是去执行一个 shell script （可传参的）
			+ 比如 开启
				+ docker平台 
					+ docker start -name mysql mysql:5.7
				+ 服务管理平台 
					+ start -servicename ZJZSService1 -.. -.. ... //服务类方式运行
					+ start -entrypoint ZJZSTool1.dll	//程序方式运行      
##2019年6月19日
功能优化

+ 开启web任务健康检查时 会间隔3秒重试检测 可以修改为递进的方式进行检查 比如 检查序列从（3，3，3，3...）修改为 (1 2 3 4 5...) 

功能问题

+ 节点程序的标准输出都在 node.exe 的窗口， 相互之间是否会有影响
	+ 比如关闭 tomcat 后 再开启 activemq 没有反应（此时 node.exe 执行到关闭tomcat的代码并进入了阻塞，这样后续新的开启节点命令也不会执行），需要 node.exe 窗口接收  ctrl+C 后才能 继续
+ 原因： tomcat 一直争用了 窗口 等待自己关闭后才会释放
+ 解决： 打开任务程序时都是用新窗口的方式打开

##2019年6月12日
功能优化

+ 1 web任务服务  启动后 后台是能够在5秒内成功启动 但是还是提示操作超时，需要优化 

代码问题

+ 方法A 使用 多次使用同一数据库连接类， 在中间使用文件 异步写入的方法后的代码逻辑中数据库连接类丢失
	+ 可以采用 前后输出当前的 threadid 来确认代码是否切换到了一个新线程域
+  
 
##2019年6月5日
功能问题  
+ **问题**任务程序更新时有备份之前程序包的需求；任务程序的配置文件更新时有备份之前配置文件的需求 
+ **问题**任务程序的部署目录以任务名称为文件名， 所以同一个节点下不同的任务 名称不能相同
##2019年5月31日
功能问题 
	
+ **问题：**任务程序 是否发布到节点程序外的其他目录
	+ **解答** 关键是 运行的角色 生成环境目前是administrator 运行的Node 程序 加入是其他角色  则需要该角色分配这个目录 读写权限
+ 日志 可以维护到一个公共目录
问题 目前window 没有docker一样的外部磁盘挂载 可能需要采用覆盖形式的更新

	

##2019年5月29日
功能设计  功能优化
###配置文件提供多种形式的配置

+ 1 针对实施首先考虑 键值对的配置， 主要数据库连接 webservice webmicroservice restful 的接口地址。  </br><font color='red'>说明 这个配置在apollo 中完成，如果apollo 中没有配置以第2种方式进行</font>
+ 2 一些复杂的配置， 使用xml,json 文件的形式来配置 说明:需要指明路径，这样任务程序启动时会先覆盖他的配置文件
+ 3 如果觉得第二种方式复杂 有更高更简便的要求  可以在1，2 之间做一个映射关系的配置
<br> 比如 key: nodepath value   description; key 用于指定配置键值 nodepath 用于筛选定位到某个节点 可以使用xmlquery语法 
<br> key:RefreshSecretSubUrl ;nodepath:root.nodes[0].nodes[0].nodes[0];value="/gateway/app/refreshTokenByKey.htm"; description : 更新密钥的访问地址

###服务调度平台web端是否需要以及如何查看任务程序内部的fatal error 级别的错误
+ 功能需求
暂时先能查看服务是否是开启或者 停止，配合内存，cpu 来检查任务程序的运行情况
+ 功能优化
是否加入对cpu,内存指标的 异常运行的预警 

###会有java类的服务 需要管理么

+ tag 功能需求  之前console 类程序默认是 windows console netcore 的程序

##2019年5月28日  windows服务调度平台接入EWS的技术讨论

会议结果

- （1）杨君武牵头 全公司讨论本工具的产品需求
- （2）各部门收集可能需要接如的工具，分析工具的特征,此步骤在（1）后
- （3）各阶段文档 编写  立项 概要 部署等文档
- （4）演示初步考虑的如何与EWS 接入的方式（这个待前2个步骤完成后 再次具体讨论如何接入）
	- 本平台的各模块页面如何加入到EWS平台
	- 是否在ews平台开放本平台各模块的菜单，然后页面地址跳转 到本平台web页面
	- 用户权限 如何实现统一，  如何实现单点登陆，及ews平台登陆后，本平台不用再次登陆 
	- 还需要考虑  登陆过期后的跳转
	- 界面上的风格的确定
	- 一个任务程序的更新包  能否在ews平台上上传，然后发通知给实施让其录入到本平台的任务中
	- 本平台 组件的取舍，比如 redis 形式的队列
##2019年5月28日
功能优化
	内容：任务程序更新时 有些文件时不能删除的，所有不能采用先删除后完整下载的方式
	解决方式：采用docker 的外部公共目录挂载的方式，需要注意 主程序对工作目录外的目录的权限不能访问的问题

	内容： 可能存在不能纳入管理的任务程序， 比如 表单程序 完全时界面输入和多次交互型，单次交互的可以提前配置固定的参数来实现，多次交互办法一次配置
	

##2019年5月27日  接入ews的技术讨论的资料
功能模块
	任务管理
		任务主要包括
			windows控制台程序：主要用于跑定时 或者长时任务
			tomcat web服务
			jar包微服务
		定义 部署以上windows 程序服务的 到指定节点服务器，完成服务的更新，开启，关闭 ，监控（主要是程序的运行状态和 cpu 内存的使用指标）
	节点管理
		定义  运行任务的服务器的管理， 节点下会预先部署一个控制台程序，用户调度配置运行在本服务器下的任务
		
	日志模块
	性能指标查看模块
		主要是任务程序的运行状态和 cpu 内存的使用指标 
	命令列表
		定义 展示所有发送的命令的 状态列表。 命令是对任务进行管理的消息，命令包括 启动 关闭 卸载 等

EWS 相关
	本平台的各模块如何加入到EWS平台
		是否在ews平台开放本平台各模块的菜单，然后页面地址跳转 到本平台web页面
	用户权限 如何实现统一，  如何实现单点登陆，及ews平台登陆后，本平台不用再次登陆 
		还需要考虑  登陆过期后的跳转
	界面上的风格的确定
	一个任务程序的更新包  能否在ews平台上上传，然后发通知给实施让其录入到本平台的任务中
	本平台 组件的取舍，比如 redis 形式的队列

## 2019年5月27日 
优化

内容：程序包可以设置部署在服务器的任意目录
方式：提供目录的选择，目录切换时，需要移动当前的程序包
之前方式是：统一部署到node节点设置的目录下

内容：程序包 可以以覆盖形式更新 tomcat服务文件也可以以覆盖形式更新
方式: 上传时就 对压缩包进行解压更新
之前方式是：删除原先程序包 重新下载



## 2019年5月24日 开发设计讨论
讨论内容

+ 1 提供一些设计上的建议
+ 2 是否需要及如何合并到EWS 中
+ 3 从EWS 对于相似功能的可借鉴之处

讨论结果

+ 1 服务调度平台 需要加入 tomcat 包的部署和更新
+ 2 如何合并到 EWS中， 不做代码上的合并， 页面入口跳转进入模块 
	此处需要之前EWS平台的配合传入 用户认证和权限信息
	调度平台 以EWS的方式进行认证
+ 3 第三方技术组件选型需要 偏向ews已选用的技术组件 比如 redis  切换为 MQ
+ 4 mysql 关系型数据库 存储程序包 后期数据量过大 影响性能   考虑后期使用mongodb或者 NAS(网络区域存储)
+ 5 直接kill 的方式优化  考虑能否使用更优雅的方式 终止进程

参加人
王益杰 卢俊强 等

## 2019年5月24日 问题
+ 1 microservice 各类型的微服务 如何监控健康状态 以及 性能指标


## 2019年5月10日 开发评审
问题

+ 1 用户管理
	目前是预先在webconfig 中配置几个用户的账号和密码同时需要在平台的用户管理中加入此用户 来实现
	管理员可以创建新用户，也只有管理员可以创建用户
+ 2 权限管理
	简单方式：按节点来管理，管理员可以按节点授权
	复杂：按任务，分查看用户和 操作用户
+ 3 邮件通知
	问题：如果是内网是否可以架设内部邮件服务
	回答：
		提供两个选择，开发两种邮件服务方案的实现，通过配置进行切换
可以使用基础平台的邮件服务
或者Exchange 2003 Server 发送
+ 4 tomcat服务
	服务文件的更新 线下手动进行
	可设置 网站app路径，端口，健康检查路径和间隔
	度量参数：服务内存和cpu使用

	Tomcat启动失败时的日志记录和查看


+ 5 管理任务程序的配置参数
	实现方式：提供录入配置参数的窗口  内容格式： 目录+文件名+文件内容+配置内容。优先级高于任务
	程序内部的配置文件，在启动任务程序时去替换
容易出错的点：配置内容中特殊字符的解析问题
		
+ 6不动产登记一窗系统都微服务架构（SOA）的，各个微服务都很好的监控，那么这个调度平台的定位是哪些
	初步解读： windows 上的netcore 服务;windows上的 tomcat web server
	Iis不考虑；java 有微服务，需要jar包启动（管理微服务的开启，关闭）

+ 7 工具不足
	定制方面不灵活，没有jekins,zabbix灵活，软件后期调整相对困难，所以需要确定主要的需求
+ 8 工具约束
	任务程序定时任务不能托管给服务
	同一节点相同的 任务服务只能开启一个
	Net程序使用Netcore平台，方便后期一致到linux
	Winform 类的工具不加入调度范围
之前netframwork 版的程序迁移到netcore 不会使用winform

Answer:

+ 1 用户和权限管理可以结合EWS平台
+ 2 微服务架构的不动产一窗Sping admin 仅仅完成了监控，没有开启和调度的功能，所以需要对这一类微服务进行调度，（windows 或者 linux 系统环境都有），对jar包方式的微服务的开启，关闭，不需要考虑IIs web server 的application
+ 3 需要可以在远端部署节点程序到window系统
+ 4提供调度平台各个组件的一件安装包，包括node,web,redis,mysql
+ 5 Netcore类型的工具的配置文件需要确定简单的规范，方便调度平台开放入口来补充配置
+ 6 调度平台可以考虑导入properties类型配置，键值对的方式
+ 7邮件服务 内网不要求加入，所以不需要考虑加入microsoft 的 exchange server;外网可以使用 163，qq的发送邮件
+ 8 政务内网到外网有可能只支持单向通信，需要评估这种情况给本平台带来的影响
初步考虑如果有这种限制，则部署两套调度平台
+ 9 需要考虑 这个平台有没有必要集成到 EWS,及如何集成
+ 10 再未接入ELK平台之前，如何查看微服务的日志（属于优化完善类需求）


参会人
倪明奇 黄秀平 赵杰 冯珏庆 唐豹 卢俊强 等

##解决方案
Tomcat ,jar 类的与net 的分开来管理会比较方便

Web服务
1 属性包括 服务名 端口号 网站app路径 健康检查和检查间隔 命令行启动的脚本 
问题  是否可以用端口号来确定 web服务，从而通过端口号查进程
解答  此处主要考虑 每个服务的启动方式 和其进程的情况
问题 通过终止进程的方式关闭进程， 程序是否安全
解答

2 如果需要管理tomcat 服务的部署， 需要上传整个文件包 及部署路径
